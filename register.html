<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Regestration</title>
    <link rel="stylesheet" type="text/css" href="reg.css">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const login_Btn = document.getElementById('login_Btn');
            const reg_Btn = document.getElementById('reg_Btn');
            const slider = document.querySelector('.slider');
            const outline = document.querySelector('.login-outline');

            const loginForm = document.querySelector('.login');
            const registerForm = document.querySelector('.register');

            login_Btn.addEventListener('click', () => {
              login_Btn.classList.add('active');
              reg_Btn.classList.remove('active');
              slider.style.left = '5px';

              loginForm.classList.add('show');
              registerForm.classList.remove('show');
              outline.classList.remove('active');
            });

            reg_Btn.addEventListener('click', () => {
              reg_Btn.classList.add('active');
              login_Btn.classList.remove('active');
              slider.style.left = 'calc(50% + 5px)';

              registerForm.classList.add('show');
              loginForm.classList.remove('show');
              outline.classList.add('active');
            });
        });
    </script>
</head>
<body>
    <div class="background_color"></div>
    <div class="background"></div>
    <header>
        <a href="home.php"><p class="close-iframe">&#8592 Return </p></a>
    </header>

    <div class="login-outline">
            <div class="title">
                <div class="login_logo">
                    <img src="Image/logo.png">
                    <h1> ASTRALIKS </h1>
                </div>
            </div>

        <div class="switcher">
            <div class="toggle-switch">
                <div class="slider"></div>
                <button id="login_Btn" class="switch-btn active">Sign in</button>
                <button id="reg_Btn" class="switch-btn">Sign up</button>
            </div>
        </div>

        <div class="form login show">

            <div class="login-input">
                <form id="loginForm">
                    <input type="text" id="username" placeholder="Login" autocomplete="off" required>

                    <input type="password" id="password" placeholder="Password" autocomplete="off" required>

                    <button type="button" class="sing-in" onclick="login()"> Sign In </button>
                </form>
            </div>
            <div class="circles">
                <img src="Image/circles.svg">
            </div>
        </div>

        <div class="form register">
            <div class="reg-input">
                <form action="regestration.php" method="post">
                    <input type="text" id="username" name="fname" placeholder="Login" autocomplete="off" required>

                    <input type="text" id="email" name="email" placeholder="Email" autocomplete="off" required>

                    <input type="text" id="password" name="password" placeholder="Password" autocomplete="off" required>

                    <input type="text" id="repeat-password" name="repeat-password" placeholder="Repeat Password" autocomplete="off" required>

                    <button type="submit" class="reg-sing-in"> Sign Up </button>
                </form>
            </div>
            <div class="circles">
                <img src="Image/circles.svg">
            </div>
        </div>

    </div>

    <script>
    async function login() {
        console.log("Функция login() вызвана"); // Проверка срабатывания
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        console.log("Введённые данные:", {username, password}); // Проверка значений

        try {
            console.log("Отправка запроса...");
            
            const response = await fetch('login.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    fname: username,
                    password: password
                })
            });

            console.log("Ответ получен, статус:", response.status);
            
            const data = await response.json();
            console.log("Данные ответа:", data);

            if (data.status === "success") {
                localStorage.setItem('token', data.token);
                console.log("Токен сохранён, перенаправляю...");
                window.location.href = 'profile.php';
            } else {
                alert(data.message || 'Ошибка сервера');
            }
        } catch (error) {
            console.error("Полная ошибка:", error);
            alert('Ошибка соединения: ' + error.message);
        }
    }

    // Функция проверки и декодирования токена
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    // Проверка авторизации при загрузке страницы
    function checkAuth() {
        const token = localStorage.getItem("token");
        
        if (!token) {
            console.log("Пользователь не авторизован");
            return;
        }

        const decoded = parseJwt(token);
        
        if (!decoded) {
            console.error("Неверный формат токена");
            return;
        }

        // Проверка срока действия токена
        if (decoded.exp && Date.now() / 1000 > decoded.exp) {
            localStorage.removeItem("token");
            console.log("Токен истёк");
            return;
        }

        console.log("Текущий пользователь:", decoded.username);
        
        // Если пользователь авторизован, можно обновить интерфейс
        if (decoded.username) {
            const loginBtn = document.getElementById('login-btn');
            const profileBtn = document.getElementById('profile-btn');
            if (loginBtn) loginBtn.style.display = 'none';
            if (profileBtn) profileBtn.style.display = 'block';
        }
    }

    // Функция выхода
    function logout() {
        localStorage.removeItem("token");
        window.location.reload();
    }

    // Проверяем авторизацию при загрузке страницы
    document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>
